import{u as v,j as e}from"./index-b8b8b179.js";import{r as b}from"./vendor-ce4ffebd.js";import{s as p}from"./storage-8020bd0d.js";import{c as S}from"./dateUtils-280973c0.js";import{P as N,k as C,C as T,i as w,h as y}from"./icons-09cb8d8e.js";import"./routing-89dfa7f7.js";import"./supabase-e6e84841.js";const U=()=>{const{user:s}=v(),[x,j]=b.useState([]),[t,n]=b.useState([]),[o,a]=b.useState([]),[h,g]=b.useState(!1),[c,l]=b.useState("active");b.useEffect(()=>{d()},[]);const d=()=>{j(p.getEvents()),n(p.getEventResults()),a(p.getUsers().filter(i=>i.role==="CHILD"))},m=x.filter(i=>i.dueDate?new Date(i.dueDate)>=new Date:!0),u=x.filter(i=>i.dueDate?new Date(i.dueDate)<new Date:!1),r=i=>t.filter(f=>f.eventId===i),E=i=>{const f=o.find(D=>D.id===i);return(f==null?void 0:f.name)||"不明"};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsx("h2",{className:"text-3xl font-bold text-purple-800",children:"🎉 イベント管理"}),(s==null?void 0:s.role)==="PARENT"&&e.jsxs("button",{onClick:()=>g(!0),className:"btn-primary flex items-center gap-2",children:[e.jsx(N,{className:"w-5 h-5"}),"✨ 新しいイベント"]})]}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"flex gap-2 mb-6",children:[e.jsxs("button",{onClick:()=>l("active"),className:`px-6 py-3 rounded-full font-bold transition-all ${c==="active"?"bg-gradient-to-r from-blue-500 to-purple-500 text-white shadow-lg":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:["🔥 アクティブイベント (",m.length,")"]}),e.jsxs("button",{onClick:()=>l("completed"),className:`px-6 py-3 rounded-full font-bold transition-all ${c==="completed"?"bg-gradient-to-r from-blue-500 to-purple-500 text-white shadow-lg":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:["✅ 完了イベント (",u.length,")"]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4",children:[(c==="active"?m:u).map(i=>e.jsx(P,{event:i,results:r(i.id),children:o,getChildName:E,onUpdate:d},i.id)),(c==="active"?m:u).length===0&&e.jsx("div",{className:"col-span-full text-center py-12",children:e.jsx("p",{className:"text-purple-600 text-lg",children:c==="active"?"🎯 アクティブなイベントはありません":"📅 完了したイベントはありません"})})]})]}),h&&e.jsx(A,{onClose:()=>g(!1),onSave:d,children:o})]})},P=({event:s,results:x,children:j,getChildName:t,onUpdate:n})=>{const{user:o}=v(),[a,h]=b.useState(!1),g=s.assignedTo?j.find(r=>r.id===s.assignedTo):null,c=s.dueDate&&new Date(s.dueDate)<new Date,l=x.find(r=>r.childId===(o==null?void 0:o.id)),d=(o==null?void 0:o.role)==="CHILD"&&(!s.assignedTo||s.assignedTo===o.id)&&!l&&!c,m=r=>{switch(r){case"SCORE_BASED":return"📊";case"EVALUATION_BASED":return"⭐";case"COMPLETION_BASED":return"✅";default:return"🎯"}},u=r=>{switch(r){case"SCORE_BASED":return"点数ベース";case"EVALUATION_BASED":return"評価ベース";case"COMPLETION_BASED":return"完了ベース";default:return r}};return e.jsxs("div",{className:`p-6 rounded-2xl border-2 shadow-lg transition-all hover:shadow-xl ${c?"bg-gradient-to-br from-gray-100 to-gray-200 border-gray-300":"bg-gradient-to-br from-yellow-100 to-orange-100 border-yellow-300"}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-lg text-orange-800",children:s.title}),e.jsx("p",{className:"text-sm text-orange-600 font-medium",children:s.category})]}),e.jsx("div",{className:"text-2xl",children:m(s.eventType)})]}),e.jsx("p",{className:"text-sm text-orange-700 mb-4",children:s.description}),e.jsxs("div",{className:"space-y-2 mb-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-xs px-3 py-1 bg-orange-200 text-orange-700 rounded-full",children:u(s.eventType)}),e.jsx("span",{className:"text-xs px-3 py-1 bg-purple-200 text-purple-700 rounded-full",children:g?g.name:"全員"})]}),e.jsxs("div",{className:"flex items-center gap-2 text-sm text-orange-600",children:[e.jsx(C,{className:"w-4 h-4"}),e.jsxs("span",{children:[s.pointsConfig.basePoints,"pt ～ ",s.pointsConfig.maxPoints,"pt",s.pointsConfig.bonusPoints&&` (+${s.pointsConfig.bonusPoints}pt ボーナス)`]})]}),s.dueDate&&e.jsxs("div",{className:"flex items-center gap-2 text-sm text-orange-600",children:[e.jsx(T,{className:"w-4 h-4"}),e.jsxs("span",{children:["期限: ",new Date(s.dueDate).toLocaleDateString("ja-JP")]}),c&&e.jsx("span",{className:"text-red-500 font-bold",children:"（期限切れ）"})]})]}),x.length>0&&e.jsxs("div",{className:"mb-4",children:[e.jsx("h4",{className:"font-bold text-sm text-orange-800 mb-2",children:"📝 結果"}),e.jsx("div",{className:"space-y-2",children:x.map(r=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-white rounded-lg border border-orange-200",children:[e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-sm",children:t(r.childId)}),e.jsxs("div",{className:"text-xs text-gray-600",children:[r.resultType==="SCORE"&&`${r.score}点`,r.resultType==="EVALUATION"&&r.evaluation,r.resultType==="COMPLETED"&&"完了"]})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("span",{className:"font-bold text-purple-600",children:[r.earnedPoints,"pt"]}),r.bonusEarned&&e.jsx("span",{className:"text-xs text-green-600 block",children:"ボーナス獲得！"})]})]},r.id))})]}),d&&e.jsxs("button",{onClick:()=>h(!0),className:"w-full btn-primary text-sm flex items-center justify-center gap-2",children:[e.jsx(w,{className:"w-4 h-4"}),"🚀 結果を報告"]}),l&&e.jsxs("div",{className:"flex items-center gap-2 text-sm",children:[e.jsx(y,{className:"w-4 h-4 text-green-500"}),e.jsxs("span",{className:"text-green-600 font-medium",children:["結果報告済み (",l.earnedPoints,"pt獲得)"]})]}),a&&e.jsx(O,{event:s,onClose:()=>h(!1),onSave:n})]})},A=({onClose:s,onSave:x,children:j})=>{const[t,n]=b.useState({title:"",description:"",category:"テスト",eventType:"SCORE_BASED",assignedTo:"",basePoints:10,maxPoints:50,bonusPoints:10,targetScore:80,dueDate:""}),o=a=>{var c;a.preventDefault();const h=p.getEvents(),g={id:p.generateId(),title:t.title,description:t.description,category:t.category,eventType:t.eventType,pointsConfig:{basePoints:t.basePoints,maxPoints:t.maxPoints,bonusPoints:t.bonusPoints,targetScore:t.targetScore,scoreThresholds:t.eventType==="SCORE_BASED"?[{score:90,points:t.maxPoints},{score:80,points:Math.floor(t.maxPoints*.8)},{score:70,points:Math.floor(t.maxPoints*.6)},{score:60,points:Math.floor(t.maxPoints*.4)},{score:0,points:t.basePoints}]:void 0},assignedTo:t.assignedTo||void 0,createdBy:((c=p.getCurrentUser())==null?void 0:c.id)||"",dueDate:t.dueDate?new Date(t.dueDate):void 0,createdAt:new Date};h.push(g),p.saveEvents(h),x(),s()};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-pink-50 rounded-3xl p-8 w-full max-w-2xl border-4 border-purple-300 shadow-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx("h3",{className:"text-2xl font-bold text-purple-800 mb-6 text-center",children:"🎉 新しいイベントを作成"}),e.jsxs("form",{onSubmit:o,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-bold text-purple-700 mb-2",children:"📝 イベント名"}),e.jsx("input",{type:"text",value:t.title,onChange:a=>n({...t,title:a.target.value}),className:"input-field",placeholder:"例: 算数のテスト",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-bold text-purple-700 mb-2",children:"🏷️ カテゴリ"}),e.jsxs("select",{value:t.category,onChange:a=>n({...t,category:a.target.value}),className:"input-field",children:[e.jsx("option",{value:"テスト",children:"テスト"}),e.jsx("option",{value:"発表会",children:"発表会"}),e.jsx("option",{value:"コンクール",children:"コンクール"}),e.jsx("option",{value:"習い事",children:"習い事"}),e.jsx("option",{value:"その他",children:"その他"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-bold text-purple-700 mb-2",children:"📋 説明"}),e.jsx("textarea",{value:t.description,onChange:a=>n({...t,description:a.target.value}),className:"input-field",rows:3,placeholder:"イベントの詳細を説明してください"})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-bold text-purple-700 mb-2",children:"⚙️ イベントタイプ"}),e.jsxs("select",{value:t.eventType,onChange:a=>n({...t,eventType:a.target.value}),className:"input-field",children:[e.jsx("option",{value:"SCORE_BASED",children:"📊 点数ベース（テスト等）"}),e.jsx("option",{value:"EVALUATION_BASED",children:"⭐ 評価ベース（発表会等）"}),e.jsx("option",{value:"COMPLETION_BASED",children:"✅ 完了ベース"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-bold text-purple-700 mb-2",children:"👧 対象"}),e.jsxs("select",{value:t.assignedTo,onChange:a=>n({...t,assignedTo:a.target.value}),className:"input-field",children:[e.jsx("option",{value:"",children:"全員"}),j.map(a=>e.jsxs("option",{value:a.id,children:[a.name," (",a.birthDate?`${S(a.birthDate)}歳`:`${a.age||0}歳`,")"]},a.id))]})]})]}),e.jsxs("div",{className:"grid grid-cols-2 md:grid-cols-4 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-purple-700 mb-2",children:"💎 基本ポイント"}),e.jsx("input",{type:"number",value:t.basePoints,onChange:a=>n({...t,basePoints:parseInt(a.target.value)}),className:"input-field",min:"1",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-purple-700 mb-2",children:"✨ 最大ポイント"}),e.jsx("input",{type:"number",value:t.maxPoints,onChange:a=>n({...t,maxPoints:parseInt(a.target.value)}),className:"input-field",min:"1",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-purple-700 mb-2",children:"🎁 ボーナス"}),e.jsx("input",{type:"number",value:t.bonusPoints,onChange:a=>n({...t,bonusPoints:parseInt(a.target.value)}),className:"input-field",min:"0"})]}),t.eventType==="SCORE_BASED"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-bold text-purple-700 mb-2",children:"🎯 目標点数"}),e.jsx("input",{type:"number",value:t.targetScore,onChange:a=>n({...t,targetScore:parseInt(a.target.value)}),className:"input-field",min:"0",max:"100"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-bold text-purple-700 mb-2",children:"📅 期限（任意）"}),e.jsx("input",{type:"date",value:t.dueDate,onChange:a=>n({...t,dueDate:a.target.value}),className:"input-field"})]}),e.jsxs("div",{className:"flex justify-center gap-4",children:[e.jsx("button",{type:"button",onClick:s,className:"btn-secondary text-lg px-8",children:"🔙 キャンセル"}),e.jsxs("button",{type:"submit",className:"btn-primary text-lg flex items-center gap-3 px-8",children:[e.jsx(N,{className:"w-6 h-6"}),"🎉 作成"]})]})]})]})})},O=({event:s,onClose:x,onSave:j})=>{const{user:t}=v(),[n,o]=b.useState({score:0,evaluation:"",comments:""}),a=()=>{const{pointsConfig:l}=s;let d=l.basePoints,m=!1;if(s.eventType==="SCORE_BASED"&&l.scoreThresholds){for(const u of l.scoreThresholds)if(n.score>=u.score){d=u.points;break}l.targetScore&&n.score>=l.targetScore&&l.bonusPoints&&(d+=l.bonusPoints,m=!0)}else s.eventType==="COMPLETION_BASED"&&(d=l.maxPoints,l.bonusPoints&&(d+=l.bonusPoints,m=!0));return{earnedPoints:d,bonusEarned:m}},h=l=>{if(l.preventDefault(),!t)return;const{earnedPoints:d,bonusEarned:m}=a(),u=p.getEventResults(),r={id:p.generateId(),eventId:s.id,childId:t.id,resultType:s.eventType==="SCORE_BASED"?"SCORE":s.eventType==="EVALUATION_BASED"?"EVALUATION":"COMPLETED",score:s.eventType==="SCORE_BASED"?n.score:void 0,evaluation:s.eventType==="EVALUATION_BASED"?n.evaluation:void 0,earnedPoints:d,bonusEarned:m,submittedAt:new Date,status:"PENDING",comments:n.comments};u.push(r),p.saveEventResults(u),j(),x()},{earnedPoints:g,bonusEarned:c}=a();return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-pink-50 rounded-3xl p-8 w-full max-w-md border-4 border-purple-300 shadow-2xl",children:[e.jsx("h3",{className:"text-2xl font-bold text-purple-800 mb-6 text-center",children:"📝 結果を報告"}),e.jsxs("div",{className:"mb-6 p-4 bg-gradient-to-br from-yellow-100 to-orange-100 rounded-2xl border-2 border-yellow-300",children:[e.jsx("h4",{className:"font-bold text-orange-800",children:s.title}),e.jsx("p",{className:"text-sm text-orange-600 mt-1",children:s.description})]}),e.jsxs("form",{onSubmit:h,className:"space-y-6",children:[s.eventType==="SCORE_BASED"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-bold text-purple-700 mb-2",children:"📊 点数"}),e.jsx("input",{type:"number",value:n.score,onChange:l=>o({...n,score:parseInt(l.target.value)||0}),className:"input-field text-center text-2xl",min:"0",max:"100",placeholder:"点数を入力",required:!0})]}),s.eventType==="EVALUATION_BASED"&&e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-bold text-purple-700 mb-2",children:"⭐ 評価"}),e.jsxs("select",{value:n.evaluation,onChange:l=>o({...n,evaluation:l.target.value}),className:"input-field",required:!0,children:[e.jsx("option",{value:"",children:"評価を選択"}),e.jsx("option",{value:"とてもよくできました",children:"とてもよくできました"}),e.jsx("option",{value:"よくできました",children:"よくできました"}),e.jsx("option",{value:"できました",children:"できました"}),e.jsx("option",{value:"がんばりましょう",children:"がんばりましょう"})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-bold text-purple-700 mb-2",children:"💭 コメント（任意）"}),e.jsx("textarea",{value:n.comments,onChange:l=>o({...n,comments:l.target.value}),className:"input-field",rows:3,placeholder:"がんばったことや感想を書いてね"})]}),e.jsxs("div",{className:"p-4 bg-gradient-to-r from-green-100 to-emerald-100 rounded-2xl border-2 border-green-300",children:[e.jsx("h4",{className:"font-bold text-green-800 mb-2",children:"🎉 獲得予定ポイント"}),e.jsxs("div",{className:"text-3xl font-bold text-green-600 text-center",children:[g,"pt",c&&e.jsx("span",{className:"text-lg text-yellow-600 block",children:"+ ボーナス獲得！"})]})]}),e.jsxs("div",{className:"flex justify-center gap-4",children:[e.jsx("button",{type:"button",onClick:x,className:"btn-secondary text-lg px-8",children:"🔙 キャンセル"}),e.jsxs("button",{type:"submit",className:"btn-primary text-lg flex items-center gap-3 px-8",children:[e.jsx(y,{className:"w-6 h-6"}),"📤 送信"]})]})]})]})})};export{U as default};
