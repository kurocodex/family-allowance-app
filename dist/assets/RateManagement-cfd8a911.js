import{j as e}from"./index-c2744e47.js";import{r as p}from"./vendor-ce4ffebd.js";import{s as b}from"./storage-8020bd0d.js";import{c as C}from"./dateUtils-280973c0.js";import{P as R,T as P}from"./icons-09cb8d8e.js";import"./routing-89dfa7f7.js";import"./supabase-e6e84841.js";const L=()=>{const[t,u]=p.useState([]),[s,r]=p.useState([]),[g,n]=p.useState(!1),[l,m]=p.useState("active");p.useEffect(()=>{o()},[]);const o=()=>{const i=b.getRateRules();u(i),r(b.getUsers().filter(d=>d.role==="CHILD"))},v=(i,d,x)=>{const h=s.find(a=>a.id===i);if(!h)return{finalPoints:d,appliedRules:[]};const c=h.birthDate?C(h.birthDate):h.age||0,A=new Date;let j=d,E=[];return t.filter(a=>a.isActive).forEach(a=>{let D=!1;switch(a.type){case"AGE_BASED":a.conditions.minAge!==void 0&&c>=a.conditions.minAge&&(a.conditions.maxAge===void 0||c<=a.conditions.maxAge)&&(D=!0);break;case"PERIOD_BASED":if(a.conditions.startDate&&a.conditions.endDate){const k=new Date(a.conditions.startDate),S=new Date(a.conditions.endDate);A>=k&&A<=S&&(!a.conditions.taskCategory||a.conditions.taskCategory===x)&&(D=!0)}break;case"PERFORMANCE_BASED":(!a.conditions.taskCategory||a.conditions.taskCategory===x)&&(D=!0);break}D&&(j=Math.round(j*a.multiplier),a.bonusPoints&&(j+=a.bonusPoints),E.push(a.name))}),{finalPoints:j,appliedRules:E}},f=i=>{const d=s.find(c=>c.id===i);if(!d)return[];const x=d.birthDate?C(d.birthDate):d.age||0,h=new Date;return t.filter(c=>c.isActive).filter(c=>{switch(c.type){case"AGE_BASED":return c.conditions.minAge!==void 0&&x>=c.conditions.minAge&&(c.conditions.maxAge===void 0||x<=c.conditions.maxAge);case"PERIOD_BASED":if(c.conditions.startDate&&c.conditions.endDate){const A=new Date(c.conditions.startDate),j=new Date(c.conditions.endDate);return h>=A&&h<=j}return!1;case"PERFORMANCE_BASED":return!0;default:return!1}})},N=i=>{if(confirm("このレート設定を削除してもよろしいですか？")){const d=t.filter(x=>x.id!==i);u(d),b.saveRateRules(d)}},y=i=>{const d=t.map(x=>x.id===i?{...x,isActive:!x.isActive}:x);u(d),b.saveRateRules(d)};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsx("h2",{className:"text-3xl font-bold text-purple-800",children:"⚙️ レート設定システム"}),e.jsxs("button",{onClick:()=>n(!0),className:"btn-primary flex items-center gap-2",children:[e.jsx(R,{className:"w-5 h-5"}),"✨ 新しいレート設定"]})]}),e.jsxs("div",{className:"card",children:[e.jsxs("div",{className:"flex gap-2 mb-6",children:[e.jsxs("button",{onClick:()=>m("active"),className:`px-6 py-3 rounded-full font-bold transition-all ${l==="active"?"bg-gradient-to-r from-green-500 to-blue-500 text-white shadow-lg":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:["🔥 適用中のレート (",t.filter(i=>i.isActive).length,")"]}),e.jsxs("button",{onClick:()=>m("rules"),className:`px-6 py-3 rounded-full font-bold transition-all ${l==="rules"?"bg-gradient-to-r from-green-500 to-blue-500 text-white shadow-lg":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:["📋 全レート設定 (",t.length,")"]}),e.jsx("button",{onClick:()=>m("preview"),className:`px-6 py-3 rounded-full font-bold transition-all ${l==="preview"?"bg-gradient-to-r from-green-500 to-blue-500 text-white shadow-lg":"bg-gray-200 text-gray-700 hover:bg-gray-300"}`,children:"👀 ポイント計算プレビュー"})]}),l==="active"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-green-700 mb-4",children:"🔥 現在適用中のレート設定"}),e.jsxs("div",{className:"space-y-4",children:[t.filter(i=>i.isActive).map(i=>e.jsx(w,{rate:i,onToggle:y,onDelete:N,children:s},i.id)),t.filter(i=>i.isActive).length===0&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-green-600",children:"📝 現在適用中のレート設定はありません"}),e.jsx("p",{className:"text-green-500 text-sm mt-2",children:"新しいレート設定を作成してみてください。"})]})]})]}),l==="rules"&&e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-gray-700 mb-4",children:"📋 すべてのレート設定"}),e.jsxs("div",{className:"space-y-4",children:[t.map(i=>e.jsx(w,{rate:i,onToggle:y,onDelete:N,children:s},i.id)),t.length===0&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-gray-600",children:"📝 まだレート設定がありません"}),e.jsx("p",{className:"text-gray-500 text-sm mt-2",children:"最初のレート設定を作成してみてください。"})]})]})]}),l==="preview"&&e.jsx(B,{children:s,previewFunction:v,getActiveRules:f})]}),g&&e.jsx(I,{onClose:()=>n(!1),onSave:o,children:s})]})},w=({rate:t,onToggle:u,onDelete:s})=>{const r=l=>{switch(l){case"AGE_BASED":return"👶";case"PERIOD_BASED":return"📅";case"PERFORMANCE_BASED":return"🏆";default:return"⚙️"}},g=l=>{switch(l){case"AGE_BASED":return"年齢ベース";case"PERIOD_BASED":return"期間ベース";case"PERFORMANCE_BASED":return"実績ベース";default:return l}},n=l=>{switch(l.type){case"AGE_BASED":if(l.conditions.minAge!==void 0){const m=l.conditions.maxAge!==void 0?`${l.conditions.maxAge}歳`:"以上";return`${l.conditions.minAge}歳${l.conditions.maxAge!==void 0?`～${m}`:"以上"}`}return"年齢条件なし";case"PERIOD_BASED":if(l.conditions.startDate&&l.conditions.endDate){const m=new Date(l.conditions.startDate).toLocaleDateString("ja-JP"),o=new Date(l.conditions.endDate).toLocaleDateString("ja-JP");return`${m} ～ ${o}`}return"期間設定なし";case"PERFORMANCE_BASED":return l.conditions.completionCount?`${l.conditions.completionCount}回以上完了`:"実績条件なし";default:return"条件不明"}};return e.jsxs("div",{className:`p-6 rounded-2xl border-2 shadow-lg transition-all ${t.isActive?"bg-gradient-to-br from-green-50 to-blue-50 border-green-300":"bg-gradient-to-br from-gray-50 to-gray-100 border-gray-300"}`,children:[e.jsxs("div",{className:"flex items-start justify-between mb-4",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"text-2xl",children:r(t.type)}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-bold text-lg text-gray-800",children:t.name}),e.jsx("p",{className:"text-sm text-gray-600",children:g(t.type)})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("button",{onClick:()=>u(t.id),className:`px-4 py-2 rounded-full text-sm font-medium transition-all ${t.isActive?"bg-green-500 text-white hover:bg-green-600":"bg-gray-300 text-gray-700 hover:bg-gray-400"}`,children:t.isActive?"有効":"無効"}),e.jsx("button",{onClick:()=>s(t.id),className:"p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-full transition-colors",title:"削除",children:e.jsx(P,{className:"w-4 h-4"})})]})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-3 gap-4 mb-4",children:[e.jsxs("div",{className:"p-3 bg-white rounded-lg border border-gray-200",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"適用条件"}),e.jsx("p",{className:"font-medium text-gray-800",children:n(t)})]}),e.jsxs("div",{className:"p-3 bg-white rounded-lg border border-gray-200",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"ポイント倍率"}),e.jsxs("p",{className:"font-bold text-blue-600",children:[t.multiplier,"x"]})]}),t.bonusPoints&&e.jsxs("div",{className:"p-3 bg-white rounded-lg border border-gray-200",children:[e.jsx("p",{className:"text-xs text-gray-500 mb-1",children:"ボーナス"}),e.jsxs("p",{className:"font-bold text-green-600",children:["+",t.bonusPoints,"pt"]})]})]}),e.jsx("p",{className:"text-sm text-gray-700 mb-3",children:t.description}),t.conditions.taskCategory&&e.jsxs("div",{className:"inline-block px-3 py-1 bg-purple-100 text-purple-700 rounded-full text-xs font-medium",children:["対象: ",t.conditions.taskCategory]})]})},B=({children:t,previewFunction:u,getActiveRules:s})=>{const[r,g]=p.useState(10),[n,l]=p.useState("家事"),m=["家事","勉強","運動","その他"];return e.jsxs("div",{children:[e.jsx("h3",{className:"text-xl font-bold text-blue-700 mb-4",children:"👀 ポイント計算プレビュー"}),e.jsx("div",{className:"mb-6 p-4 bg-blue-50 rounded-lg border border-blue-200",children:e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-blue-700 mb-2",children:"基本ポイント"}),e.jsx("input",{type:"number",value:r,onChange:o=>g(parseInt(o.target.value)||10),className:"input-field",min:"1",max:"100"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-blue-700 mb-2",children:"カテゴリ"}),e.jsx("select",{value:n,onChange:o=>l(o.target.value),className:"input-field",children:m.map(o=>e.jsx("option",{value:o,children:o},o))})]})]})}),e.jsxs("div",{className:"space-y-4",children:[t.map(o=>{const{finalPoints:v,appliedRules:f}=u(o.id,r,n),N=s(o.id);return e.jsxs("div",{className:"p-4 bg-gradient-to-r from-yellow-50 to-orange-50 rounded-lg border border-yellow-200",children:[e.jsxs("div",{className:"flex items-center justify-between mb-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-orange-800",children:o.name}),e.jsx("p",{className:"text-sm text-orange-600",children:o.birthDate?`${C(o.birthDate)}歳`:`${o.age||0}歳`})]}),e.jsxs("div",{className:"text-right",children:[e.jsxs("p",{className:"text-2xl font-bold text-orange-700",children:[v,"pt"]}),e.jsxs("p",{className:"text-xs text-orange-600",children:["基本 ",r,"pt → 最終 ",v,"pt"]})]})]}),f.length>0&&e.jsxs("div",{className:"mt-3",children:[e.jsx("p",{className:"text-xs text-orange-600 mb-2",children:"適用されたレート:"}),e.jsx("div",{className:"flex flex-wrap gap-2",children:f.map((y,i)=>e.jsx("span",{className:"px-2 py-1 bg-orange-200 text-orange-800 rounded-full text-xs",children:y},i))})]}),N.length===0&&e.jsx("p",{className:"text-xs text-gray-500 mt-2",children:"このお子様に適用されるレート設定はありません"})]},o.id)}),t.length===0&&e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-gray-500",children:"お子様が登録されていません"})})]})]})},_=t=>t.type==="AGE_BASED"?{minAge:t.minAge?parseInt(t.minAge):void 0,maxAge:t.maxAge?parseInt(t.maxAge):void 0}:t.type==="PERIOD_BASED"?{startDate:t.startDate?new Date(t.startDate):void 0,endDate:t.endDate?new Date(t.endDate):void 0,taskCategory:t.taskCategory||void 0}:t.type==="PERFORMANCE_BASED"?{completionCount:t.completionCount?parseInt(t.completionCount):void 0,taskCategory:t.taskCategory||void 0}:{},I=({onClose:t,onSave:u})=>{const[s,r]=p.useState({name:"",type:"AGE_BASED",description:"",multiplier:1,bonusPoints:0,minAge:"",maxAge:"",startDate:"",endDate:"",taskCategory:"",completionCount:""}),g=n=>{n.preventDefault();const l=b.getRateRules(),m={id:b.generateId(),name:s.name,type:s.type,description:s.description,multiplier:s.multiplier,bonusPoints:s.bonusPoints>0?s.bonusPoints:void 0,conditions:_(s),isActive:!0,createdAt:new Date};l.push(m),b.saveRateRules(l),u(),t()};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-pink-50 rounded-3xl p-8 w-full max-w-2xl border-4 border-purple-300 shadow-2xl max-h-[90vh] overflow-y-auto",children:[e.jsx("h3",{className:"text-2xl font-bold text-purple-800 mb-6 text-center",children:"⚙️ 新しいレート設定を作成"}),e.jsxs("form",{onSubmit:g,className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-bold text-purple-700 mb-2",children:"📝 設定名"}),e.jsx("input",{type:"text",value:s.name,onChange:n=>r({...s,name:n.target.value}),className:"input-field",placeholder:"例: 小学生ボーナス",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-bold text-purple-700 mb-2",children:"⚙️ タイプ"}),e.jsxs("select",{value:s.type,onChange:n=>r({...s,type:n.target.value}),className:"input-field",children:[e.jsx("option",{value:"AGE_BASED",children:"👶 年齢ベース"}),e.jsx("option",{value:"PERIOD_BASED",children:"📅 期間ベース"}),e.jsx("option",{value:"PERFORMANCE_BASED",children:"🏆 実績ベース"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-bold text-purple-700 mb-2",children:"📋 説明"}),e.jsx("textarea",{value:s.description,onChange:n=>r({...s,description:n.target.value}),className:"input-field",rows:3,placeholder:"このレート設定の目的や適用条件を説明してください",required:!0})]}),e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-6",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-bold text-purple-700 mb-2",children:"✨ ポイント倍率"}),e.jsx("input",{type:"number",step:"0.1",min:"0.1",max:"10",value:s.multiplier,onChange:n=>r({...s,multiplier:parseFloat(n.target.value)||1}),className:"input-field",required:!0}),e.jsx("p",{className:"text-xs text-purple-600 mt-1",children:"基本ポイントにかける倍率 (例: 1.5 = 1.5倍)"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-lg font-bold text-purple-700 mb-2",children:"🎁 ボーナスポイント"}),e.jsx("input",{type:"number",min:"0",value:s.bonusPoints,onChange:n=>r({...s,bonusPoints:parseInt(n.target.value)||0}),className:"input-field"}),e.jsx("p",{className:"text-xs text-purple-600 mt-1",children:"倍率適用後に追加するボーナス"})]})]}),e.jsxs("div",{className:"p-4 bg-white rounded-lg border border-purple-200",children:[e.jsx("h4",{className:"font-bold text-purple-700 mb-4",children:"🎯 適用条件"}),s.type==="AGE_BASED"&&e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:"最小年齢"}),e.jsx("input",{type:"number",min:"0",max:"18",value:s.minAge,onChange:n=>r({...s,minAge:n.target.value}),className:"input-field",placeholder:"例: 6"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:"最大年齢（任意）"}),e.jsx("input",{type:"number",min:"0",max:"18",value:s.maxAge,onChange:n=>r({...s,maxAge:n.target.value}),className:"input-field",placeholder:"例: 12"})]})]}),s.type==="PERIOD_BASED"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-1 md:grid-cols-2 gap-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:"開始日"}),e.jsx("input",{type:"date",value:s.startDate,onChange:n=>r({...s,startDate:n.target.value}),className:"input-field",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:"終了日"}),e.jsx("input",{type:"date",value:s.endDate,onChange:n=>r({...s,endDate:n.target.value}),className:"input-field",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:"対象カテゴリ（任意）"}),e.jsxs("select",{value:s.taskCategory,onChange:n=>r({...s,taskCategory:n.target.value}),className:"input-field",children:[e.jsx("option",{value:"",children:"すべてのカテゴリ"}),e.jsx("option",{value:"家事",children:"家事"}),e.jsx("option",{value:"勉強",children:"勉強"}),e.jsx("option",{value:"運動",children:"運動"}),e.jsx("option",{value:"その他",children:"その他"})]})]})]}),s.type==="PERFORMANCE_BASED"&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:"必要完了回数"}),e.jsx("input",{type:"number",min:"1",value:s.completionCount,onChange:n=>r({...s,completionCount:n.target.value}),className:"input-field",placeholder:"例: 10"})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:"対象カテゴリ（任意）"}),e.jsxs("select",{value:s.taskCategory,onChange:n=>r({...s,taskCategory:n.target.value}),className:"input-field",children:[e.jsx("option",{value:"",children:"すべてのカテゴリ"}),e.jsx("option",{value:"家事",children:"家事"}),e.jsx("option",{value:"勉強",children:"勉強"}),e.jsx("option",{value:"運動",children:"運動"}),e.jsx("option",{value:"その他",children:"その他"})]})]})]})]}),e.jsxs("div",{className:"flex justify-center gap-4",children:[e.jsx("button",{type:"button",onClick:t,className:"btn-secondary text-lg px-8",children:"🔙 キャンセル"}),e.jsxs("button",{type:"submit",className:"btn-primary text-lg flex items-center gap-3 px-8",children:[e.jsx(R,{className:"w-6 h-6"}),"⚙️ 作成"]})]})]})]})})};export{L as default};
