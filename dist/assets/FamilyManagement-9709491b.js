import{u as C,j as e,s as g}from"./index-b8b8b179.js";import{r as h}from"./vendor-ce4ffebd.js";import{b as E,f as S,q as M,U as I,T as k}from"./icons-09cb8d8e.js";import"./routing-89dfa7f7.js";import"./supabase-e6e84841.js";const T=()=>{const{user:r}=C(),[c,a]=h.useState([]),[x,p]=h.useState(!0),[b,u]=h.useState(!1),[n,l]=h.useState("");h.useEffect(()=>{r&&f()},[r]);const d=async()=>{c.length===0&&await m()},m=async()=>{try{if(!r)return;const{data:t,error:s}=await g.from("users").select(`
          id,
          name,
          role,
          birth_date,
          age,
          created_at
        `).eq("family_id",r.familyId||"");if(s)throw s;const o=t.map(i=>({id:i.id,name:i.name,email:"",role:i.role,birthDate:i.birth_date?new Date(i.birth_date):void 0,age:i.age,createdAt:new Date(i.created_at)}));a(o)}catch(t){console.error("Error loading family members:",t)}finally{p(!1)}},f=()=>{const t=Math.random().toString(36).substring(2,8).toUpperCase();l(t)},v=async t=>{try{if(!(r!=null&&r.familyId))throw new Error("Family ID not found");const s=Math.random().toString(36).substring(2,8).toUpperCase(),o=r.email.split("@"),i=`${o[0]}+child${s}@${o[1]}`,j=`child${Math.random().toString(36).substring(2,6)}`;console.log("Creating child with email:",i);const{data:y,error:N}=await g.auth.signUp({email:i,password:j});if(N)throw N;if(y.user){const{error:w}=await g.from("users").insert({id:y.user.id,family_id:r.familyId,name:t.name,role:"CHILD",age:t.age,birth_date:t.birthDate||null,child_code:s});if(w)throw w;await m(),alert(`子供アカウントが作成されました！🎉

📱 子供用ログイン情報:
📧 メール: ${i}
🔑 パスワード: ${j}
👤 名前: ${t.name}

※メール確認が必要な場合があります`)}}catch(s){console.error("Error creating child account:",s),console.error("Error details:",JSON.stringify(s,null,2));let o="Unknown error";s instanceof Error?o=s.message:s&&typeof s=="object"&&(o=JSON.stringify(s,null,2)),alert(`子供アカウントの作成に失敗しました:

${o}

※ブラウザのConsoleタブで詳細を確認してください`)}},D=async t=>{if(confirm(`このメンバーを削除してもよろしいですか？
※データも全て削除されます`))try{const{error:s}=await g.from("users").delete().eq("id",t);if(s)throw s;await m(),alert("メンバーが削除されました")}catch(s){console.error("Error deleting member:",s),alert("メンバーの削除に失敗しました")}};return(r==null?void 0:r.role)!=="PARENT"?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-gray-500",children:"家族管理は保護者のみアクセスできます"})}):x&&c.length===0?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("h3",{className:"text-xl font-bold text-purple-700 mb-4",children:"👨‍👩‍👧‍👦 家族管理"}),e.jsx("button",{onClick:d,className:"btn-primary",children:"家族メンバーを読み込む"})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsx("h2",{className:"text-3xl font-bold text-purple-800",children:"👨‍👩‍👧‍👦 家族管理"}),e.jsxs("button",{onClick:()=>u(!0),className:"btn-primary flex items-center gap-2",children:[e.jsx(E,{className:"w-5 h-5"}),"子供を追加"]})]}),e.jsxs("div",{className:"card",children:[e.jsxs("h3",{className:"text-xl font-bold text-purple-700 mb-4 flex items-center gap-2",children:[e.jsx(S,{className:"w-6 h-6"}),"家族メンバー (",c.length,"人)"]}),e.jsx("div",{className:"grid gap-4",children:c.map(t=>e.jsx("div",{className:"p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-purple-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"text-3xl",children:t.role==="PARENT"?e.jsx(M,{className:"w-8 h-8 text-yellow-500"}):e.jsx(I,{className:"w-8 h-8 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-800",children:t.name}),e.jsxs("div",{className:"flex gap-4 text-sm text-gray-600",children:[e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${t.role==="PARENT"?"bg-yellow-100 text-yellow-700":"bg-blue-100 text-blue-700"}`,children:t.role==="PARENT"?"保護者":"子供"}),t.age&&e.jsxs("span",{children:[t.age,"歳"]}),e.jsxs("span",{children:["参加日: ",t.createdAt.toLocaleDateString("ja-JP")]})]})]})]}),t.role==="CHILD"&&e.jsx("button",{onClick:()=>D(t.id),className:"p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-full transition-colors",title:"削除",children:e.jsx(k,{className:"w-4 h-4"})})]})},t.id))}),c.length===1&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-gray-500 mb-4",children:"まだ子供が参加していません"}),e.jsx("button",{onClick:()=>u(!0),className:"btn-secondary",children:"最初の子供を追加する"})]})]}),b&&e.jsx(A,{onClose:()=>u(!1),onSave:v})]})},A=({onClose:r,onSave:c})=>{const[a,x]=h.useState({name:"",age:"",birthDate:""}),p=n=>{if(!n)return"";const l=new Date,d=new Date(n);let m=l.getFullYear()-d.getFullYear();const f=l.getMonth()-d.getMonth();return(f<0||f===0&&l.getDate()<d.getDate())&&m--,m.toString()},b=n=>{const l=n.target.value,d=p(l);x({...a,birthDate:l,age:d})},u=n=>{if(n.preventDefault(),!a.name){alert("名前は必須です");return}let l;if(a.birthDate)l=parseInt(p(a.birthDate));else if(a.age)l=parseInt(a.age);else{alert("誕生日または年齢のどちらかを入力してください");return}if(l<1||l>18){alert("年齢は1歳から18歳までの範囲で入力してください");return}c({name:a.name,age:l,birthDate:a.birthDate?new Date(a.birthDate):void 0}),r()};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-pink-50 rounded-3xl p-8 w-full max-w-md border-4 border-purple-300 shadow-2xl",children:[e.jsx("h3",{className:"text-2xl font-bold text-purple-800 mb-6 text-center",children:"👶 子供アカウントを作成"}),e.jsxs("form",{onSubmit:u,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:"名前"}),e.jsx("input",{type:"text",value:a.name,onChange:n=>x({...a,name:n.target.value}),className:"input-field",placeholder:"例: 太郎",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:"誕生日"}),e.jsx("input",{type:"date",value:a.birthDate,onChange:b,className:"input-field",max:new Date().toISOString().split("T")[0]}),e.jsx("p",{className:"text-xs text-purple-600 mt-1",children:"誕生日を入力すると年齢が自動計算されます"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:["年齢 ",a.birthDate&&"(自動計算)"]}),e.jsx("input",{type:"number",min:"1",max:"18",value:a.age,onChange:n=>x({...a,age:n.target.value}),className:"input-field",placeholder:"例: 8",disabled:!!a.birthDate}),e.jsx("p",{className:"text-xs text-purple-600 mt-1",children:a.birthDate?"誕生日から自動計算されています":"誕生日未入力の場合は手動で入力してください"})]}),e.jsxs("div",{className:"flex justify-center gap-4 pt-4",children:[e.jsx("button",{type:"button",onClick:r,className:"btn-secondary",children:"キャンセル"}),e.jsx("button",{type:"submit",className:"btn-primary",children:"作成"})]})]})]})})};export{T as default};
