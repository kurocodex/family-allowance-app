import{r as x,a as M,b as S}from"./vendor-ce4ffebd.js";import{B as U}from"./routing-89dfa7f7.js";import{c as z,_ as R}from"./supabase-e6e84841.js";import{A as D,U as L,M as W,L as J,a as B,b as V,B as N,X as O,T as A,G as H,C as Y,c as G,S as X,D as Z}from"./icons-828367c1.js";(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const n of document.querySelectorAll('link[rel="modulepreload"]'))i(n);new MutationObserver(n=>{for(const o of n)if(o.type==="childList")for(const u of o.addedNodes)u.tagName==="LINK"&&u.rel==="modulepreload"&&i(u)}).observe(document,{childList:!0,subtree:!0});function l(n){const o={};return n.integrity&&(o.integrity=n.integrity),n.referrerPolicy&&(o.referrerPolicy=n.referrerPolicy),n.crossOrigin==="use-credentials"?o.credentials="include":n.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(n){if(n.ep)return;n.ep=!0;const o=l(n);fetch(n.href,o)}})();var T={exports:{}},v={};/**
 * @license React
 * react-jsx-runtime.production.min.js
 *
 * Copyright (c) Facebook, Inc. and its affiliates.
 *
 * This source code is licensed under the MIT license found in the
 * LICENSE file in the root directory of this source tree.
 */var K=x,Q=Symbol.for("react.element"),ee=Symbol.for("react.fragment"),te=Object.prototype.hasOwnProperty,se=K.__SECRET_INTERNALS_DO_NOT_USE_OR_YOU_WILL_BE_FIRED.ReactCurrentOwner,re={key:!0,ref:!0,__self:!0,__source:!0};function q(s,t,l){var i,n={},o=null,u=null;l!==void 0&&(o=""+l),t.key!==void 0&&(o=""+t.key),t.ref!==void 0&&(u=t.ref);for(i in t)te.call(t,i)&&!re.hasOwnProperty(i)&&(n[i]=t[i]);if(s&&s.defaultProps)for(i in t=s.defaultProps,t)n[i]===void 0&&(n[i]=t[i]);return{$$typeof:Q,type:s,key:o,ref:u,props:n,_owner:se.current}}v.Fragment=ee;v.jsx=q;v.jsxs=q;T.exports=v;var e=T.exports,I={},C=M;I.createRoot=C.createRoot,I.hydrateRoot=C.hydrateRoot;const ae="https://adtsbzzizbwjiqrkqofp.supabase.co",ie="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFkdHNienppemJ3amlxcmtxb2ZwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA0ODAyNzYsImV4cCI6MjA2NjA1NjI3Nn0.Fzqt6WBr9vq17jV8hDGm5Nw2chIC2Yern7ePfQ5Sq-4",p=z(ae,ie,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!0}}),$=x.createContext(void 0),ne=({children:s})=>{const[t,l]=x.useState(null),[i,n]=x.useState(null),[o,u]=x.useState(!0);x.useEffect(()=>{g();const{data:{subscription:a}}=p.auth.onAuthStateChange(async(r,c)=>{var m;console.log("Auth state changed:",r,(m=c==null?void 0:c.user)==null?void 0:m.id),c!=null&&c.user?(n(c.user),await f(c.user.id)):(n(null),l(null)),u(!1)});return()=>{a.unsubscribe()}},[]);const g=async()=>{try{const{data:{session:a},error:r}=await p.auth.getSession();if(r){console.error("Error getting session:",r),u(!1);return}a!=null&&a.user&&(n(a.user),await f(a.user.id))}catch(a){console.error("Error in getInitialSession:",a)}finally{u(!1)}},f=async a=>{try{const{data:r,error:c}=await p.from("users").select(`
          id,
          name,
          role,
          family_id,
          birth_date,
          age,
          created_at,
          families!inner(id, name)
        `).eq("id",a).single();if(c){console.error("Error fetching user profile:",c);return}if(r){const m={id:r.id,name:r.name,email:(i==null?void 0:i.email)||"",role:r.role,familyId:r.family_id,birthDate:r.birth_date?new Date(r.birth_date):void 0,age:r.age,createdAt:new Date(r.created_at)};l(m)}}catch(r){console.error("Error in fetchUserProfile:",r)}},d=async(a,r,c,m)=>{try{const{data:w,error:P}=await p.auth.signUp({email:a,password:r});if(P)throw P;if(w.user){let _;if(m==="PARENT"){const{data:k,error:j}=await p.from("families").insert({name:`${c}さんの家族`}).select().single();if(j)throw j;_=k.id}else{const{data:k,error:j}=await p.from("families").select("id").limit(1).single();if(j)throw j;_=k.id}const{error:E}=await p.from("users").insert({id:w.user.id,family_id:_,name:c,role:m});if(E)throw E;console.log("User registered successfully")}}catch(w){throw console.error("Registration error:",w),w}},b=async(a,r)=>{try{const{error:c}=await p.auth.signInWithPassword({email:a,password:r});if(c)throw c}catch(c){throw console.error("Login error:",c),c}},h=async()=>{try{const{error:a}=await p.auth.signOut();if(a)throw a}catch(a){throw console.error("Logout error:",a),a}};return e.jsx($.Provider,{value:{user:t,supabaseUser:i,login:b,logout:h,register:d,loading:o},children:s})},y=()=>{const s=x.useContext($);if(s===void 0)throw new Error("useAuth must be used within an AuthProvider");return s},oe=async()=>{if("serviceWorker"in navigator)try{const s=await navigator.serviceWorker.register("/sw.js");return console.log("Service Worker registered successfully:",s),s.addEventListener("updatefound",()=>{console.log("Service Worker update found")}),s}catch(s){console.error("Service Worker registration failed:",s)}},le=async()=>"Notification"in window?await Notification.requestPermission()==="granted":!1,ce=()=>window.matchMedia("(display-mode: standalone)").matches||window.navigator.standalone===!0,de=(s,t,l)=>{"Notification"in window&&Notification.permission==="granted"&&new Notification(s,{body:t,icon:l||"/pwa-192x192.png",badge:"/pwa-64x64.png"})},F=x.createContext(void 0),me=()=>{const s=x.useContext(F);if(!s)throw new Error("useNotifications must be used within NotificationProvider");return s},ue=({children:s})=>{const{user:t}=y(),[l,i]=x.useState([]),n=()=>Math.random().toString(36).substr(2,9),o=h=>{const a={...h,id:n(),createdAt:new Date,read:!1};i(r=>[a,...r]),de(h.title,h.message)},u=h=>{i(a=>a.map(r=>r.id===h?{...r,read:!0}:r))},g=()=>{i(h=>h.map(a=>({...a,read:!0})))},f=()=>{i([])},d=l.filter(h=>!h.read).length;x.useEffect(()=>{if(!(t!=null&&t.familyId))return;const h=p.channel("task_completions").on("postgres_changes",{event:"INSERT",schema:"public",table:"task_completions",filter:`family_id=eq.${t.familyId}`},m=>{t.role==="PARENT"&&m.new.child_id!==t.id&&o({title:"🎯 タスク完了報告",message:"お子様がタスクを完了しました！承認をお待ちしています。",type:"task_completed",data:m.new})}).subscribe(),a=p.channel("task_approvals").on("postgres_changes",{event:"UPDATE",schema:"public",table:"task_completions",filter:`child_id=eq.${t.id}`},m=>{if(t.role==="CHILD"){const w=m.new.status;w==="APPROVED"?o({title:"✅ タスク承認",message:"タスクが承認されました！ポイントを獲得しました。",type:"task_approved",data:m.new}):w==="REJECTED"&&o({title:"❌ タスク却下",message:"タスクが却下されました。もう一度挑戦してみましょう。",type:"task_rejected",data:m.new})}}).subscribe(),r=p.channel("new_tasks").on("postgres_changes",{event:"INSERT",schema:"public",table:"tasks",filter:`family_id=eq.${t.familyId}`},m=>{t.role==="CHILD"&&(!m.new.assigned_to||m.new.assigned_to===t.id)&&o({title:"🆕 新しいクエスト",message:`新しいクエスト「${m.new.title}」が追加されました！`,type:"new_task",data:m.new})}).subscribe(),c=p.channel("point_transactions").on("postgres_changes",{event:"INSERT",schema:"public",table:"point_transactions",filter:`user_id=eq.${t.id}`},m=>{t.role==="CHILD"&&m.new.type==="EARNED"&&o({title:"💎 ポイント獲得",message:`${m.new.amount}ポイントを獲得しました！`,type:"points_awarded",data:m.new})}).subscribe();return()=>{h.unsubscribe(),a.unsubscribe(),r.unsubscribe(),c.unsubscribe()}},[t==null?void 0:t.familyId,t==null?void 0:t.id,t==null?void 0:t.role]);const b={notifications:l,unreadCount:d,markAsRead:u,markAllAsRead:g,addNotification:o,clearNotifications:f};return e.jsx(F.Provider,{value:b,children:s})},xe=()=>{const[s,t]=x.useState(!0),[l,i]=x.useState({email:"",password:"",name:"",role:"PARENT"}),[n,o]=x.useState(""),[u,g]=x.useState(!1),{login:f,register:d}=y(),b=async r=>{r.preventDefault(),o(""),g(!0);try{s?await f(l.email,l.password):(await d(l.email,l.password,l.name,l.role),alert("アカウントが作成されました！ログインしてください。"),t(!0))}catch(c){o(c.message||"エラーが発生しました")}finally{g(!1)}},h=()=>{i({email:"",password:"",name:"",role:"PARENT"}),o("")},a=()=>{t(!s),h()};return e.jsx("div",{className:"min-h-screen bg-gradient-to-br from-purple-400 via-pink-500 to-red-500 flex items-center justify-center p-4",children:e.jsxs("div",{className:"bg-white rounded-3xl shadow-2xl p-8 w-full max-w-md",children:[e.jsxs("div",{className:"text-center mb-8",children:[e.jsx("div",{className:"text-6xl mb-4",children:"🏠"}),e.jsx("h1",{className:"text-3xl font-bold text-purple-800 mb-2",children:"おこづかいクエスト"}),e.jsx("p",{className:"text-purple-600",children:s?"ログインしてください":"新しいアカウントを作成"})]}),n&&e.jsxs("div",{className:"mb-6 p-4 bg-red-50 border border-red-200 rounded-lg flex items-center gap-3",children:[e.jsx(D,{className:"w-5 h-5 text-red-500"}),e.jsx("p",{className:"text-red-700 text-sm",children:n})]}),e.jsxs("form",{onSubmit:b,className:"space-y-6",children:[!s&&e.jsxs(e.Fragment,{children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"お名前"}),e.jsxs("div",{className:"relative",children:[e.jsx(L,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"text",value:l.name,onChange:r=>i({...l,name:r.target.value}),className:"input-field pl-10",placeholder:"山田太郎",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"役割"}),e.jsxs("select",{value:l.role,onChange:r=>i({...l,role:r.target.value}),className:"input-field",required:!0,children:[e.jsx("option",{value:"PARENT",children:"👨‍👩‍👧‍👦 保護者"}),e.jsx("option",{value:"CHILD",children:"🧒 子供"})]})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"メールアドレス"}),e.jsxs("div",{className:"relative",children:[e.jsx(W,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"email",value:l.email,onChange:r=>i({...l,email:r.target.value}),className:"input-field pl-10",placeholder:"example@email.com",required:!0})]})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-gray-700 mb-2",children:"パスワード"}),e.jsxs("div",{className:"relative",children:[e.jsx(J,{className:"absolute left-3 top-1/2 transform -translate-y-1/2 text-gray-400 w-5 h-5"}),e.jsx("input",{type:"password",value:l.password,onChange:r=>i({...l,password:r.target.value}),className:"input-field pl-10",placeholder:"••••••••",minLength:6,required:!0})]}),!s&&e.jsx("p",{className:"text-xs text-gray-500 mt-1",children:"6文字以上で入力してください"})]}),e.jsx("button",{type:"submit",disabled:u,className:`w-full py-3 px-4 rounded-2xl font-bold text-lg transition-all flex items-center justify-center gap-3 ${u?"bg-gray-300 text-gray-500 cursor-not-allowed":"bg-gradient-to-r from-purple-500 to-pink-500 text-white hover:shadow-lg"}`,children:u?"処理中...":s?e.jsxs(e.Fragment,{children:[e.jsx(B,{className:"w-5 h-5"}),"ログイン"]}):e.jsxs(e.Fragment,{children:[e.jsx(V,{className:"w-5 h-5"}),"アカウント作成"]})})]}),e.jsx("div",{className:"mt-6 text-center",children:e.jsx("button",{onClick:a,className:"text-purple-600 hover:text-purple-800 text-sm font-medium",children:s?"アカウントをお持ちでない方はこちら":"すでにアカウントをお持ちの方はこちら"})}),s&&e.jsxs("div",{className:"mt-6 p-4 bg-blue-50 rounded-lg",children:[e.jsx("h3",{className:"font-bold text-blue-800 mb-2",children:"デモ用アカウント"}),e.jsx("p",{className:"text-xs text-blue-600 mb-2",children:"開発中のため、以下のアカウントでテストできます："}),e.jsxs("div",{className:"text-xs text-blue-700 space-y-1",children:[e.jsx("div",{children:"📧 test@example.com"}),e.jsx("div",{children:"🔑 password123"})]})]})]})})},he=()=>{const{notifications:s,unreadCount:t,markAsRead:l,markAllAsRead:i,clearNotifications:n}=me(),[o,u]=x.useState(!1),g=d=>{switch(d){case"task_completed":return e.jsx(A,{className:"w-5 h-5 text-blue-500"});case"task_approved":return e.jsx(Y,{className:"w-5 h-5 text-green-500"});case"task_rejected":return e.jsx(D,{className:"w-5 h-5 text-red-500"});case"points_awarded":return e.jsx(H,{className:"w-5 h-5 text-purple-500"});case"new_task":return e.jsx(A,{className:"w-5 h-5 text-orange-500"});default:return e.jsx(N,{className:"w-5 h-5 text-gray-500"})}},f=d=>{const h=new Date().getTime()-d.getTime(),a=Math.floor(h/6e4),r=Math.floor(h/36e5),c=Math.floor(h/864e5);return a<1?"たった今":a<60?`${a}分前`:r<24?`${r}時間前`:`${c}日前`};return e.jsxs("div",{className:"relative",children:[e.jsxs("button",{onClick:()=>u(!o),className:"relative p-2 text-gray-600 hover:text-purple-600 transition-colors",children:[e.jsx(N,{className:"w-6 h-6"}),t>0&&e.jsx("span",{className:"absolute -top-1 -right-1 bg-red-500 text-white text-xs rounded-full w-5 h-5 flex items-center justify-center font-bold",children:t>9?"9+":t})]}),o&&e.jsxs(e.Fragment,{children:[e.jsx("div",{className:"fixed inset-0 z-40",onClick:()=>u(!1)}),e.jsxs("div",{className:"absolute right-0 top-full mt-2 w-80 bg-white rounded-2xl shadow-2xl border border-gray-200 z-50 max-h-96 overflow-hidden",children:[e.jsx("div",{className:"p-4 border-b border-gray-100 bg-gradient-to-r from-purple-50 to-pink-50",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("h3",{className:"font-bold text-gray-800 flex items-center gap-2",children:[e.jsx(N,{className:"w-5 h-5 text-purple-600"}),"通知"]}),e.jsxs("div",{className:"flex items-center gap-2",children:[t>0&&e.jsx("button",{onClick:i,className:"text-sm text-purple-600 hover:text-purple-800 font-medium",children:"すべて既読"}),e.jsx("button",{onClick:()=>u(!1),className:"p-1 text-gray-400 hover:text-gray-600",children:e.jsx(O,{className:"w-4 h-4"})})]})]})}),e.jsx("div",{className:"max-h-64 overflow-y-auto",children:s.length===0?e.jsxs("div",{className:"p-8 text-center text-gray-500",children:[e.jsx(N,{className:"w-12 h-12 text-gray-300 mx-auto mb-3"}),e.jsx("p",{children:"通知はありません"})]}):s.map(d=>e.jsx("div",{onClick:()=>l(d.id),className:`p-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50 transition-colors ${d.read?"":"bg-blue-50 border-l-4 border-l-blue-500"}`,children:e.jsxs("div",{className:"flex items-start gap-3",children:[g(d.type),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsx("h4",{className:`font-medium text-sm ${d.read?"text-gray-700":"text-gray-900"}`,children:d.title}),e.jsx("p",{className:"text-sm text-gray-600 mt-1",children:d.message}),e.jsx("p",{className:"text-xs text-gray-400 mt-2",children:f(d.createdAt)})]}),!d.read&&e.jsx("div",{className:"w-2 h-2 bg-blue-500 rounded-full mt-2"})]})},d.id))}),s.length>0&&e.jsx("div",{className:"p-3 border-t border-gray-100 bg-gray-50",children:e.jsx("button",{onClick:n,className:"w-full text-sm text-gray-600 hover:text-gray-800 font-medium",children:"すべての通知を削除"})})]})]})]})},pe=S.lazy(()=>R(()=>import("./ParentDashboard-c56e117a.js"),["assets/ParentDashboard-c56e117a.js","assets/supabase-e6e84841.js","assets/vendor-ce4ffebd.js","assets/database-bd5ae7e7.js","assets/dateUtils-280973c0.js","assets/icons-828367c1.js","assets/routing-89dfa7f7.js"])),fe=S.lazy(()=>R(()=>import("./ChildDashboard-1ec2bd59.js"),["assets/ChildDashboard-1ec2bd59.js","assets/supabase-e6e84841.js","assets/vendor-ce4ffebd.js","assets/database-bd5ae7e7.js","assets/icons-828367c1.js","assets/routing-89dfa7f7.js"])),ge=()=>{const{user:s,logout:t}=y();return s?e.jsxs("div",{className:"min-h-screen bg-gradient-to-br from-purple-50 via-pink-50 to-blue-50",children:[e.jsx("header",{className:"bg-white shadow-sm border-b",children:e.jsx("div",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8",children:e.jsxs("div",{className:"flex justify-between items-center h-16",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"w-8 h-8 bg-primary-500 rounded-full flex items-center justify-center",children:e.jsx(L,{className:"w-4 h-4 text-white"})}),e.jsxs("div",{children:[e.jsx("h1",{className:"text-lg font-semibold text-gray-900",children:"🏰 おこづかいクエスト"}),e.jsxs("p",{className:"text-sm text-gray-600",children:[s.name,"さん (",s.role==="PARENT"?"保護者":"お子様",")"]})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(he,{}),e.jsxs("button",{onClick:t,className:"flex items-center gap-2 px-3 py-2 text-gray-600 hover:text-gray-900 hover:bg-gray-100 rounded-md transition-colors",children:[e.jsx(G,{className:"w-4 h-4"}),"ログアウト"]})]})]})})}),e.jsx("main",{className:"max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8",children:e.jsx(x.Suspense,{fallback:e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-4 border-purple-500 border-t-transparent mx-auto mb-4"}),e.jsx("p",{className:"text-purple-600 text-lg font-medium",children:"ダッシュボードを読み込み中..."})]})}),children:s.role==="PARENT"?e.jsx(pe,{}):e.jsx(fe,{})})})]}):null},be=()=>{const[s,t]=x.useState(null),[l,i]=x.useState(!1),[n,o]=x.useState(!1);x.useEffect(()=>{if(ce()||localStorage.getItem("pwa-prompt-dismissed"))return;const d=a=>{a.preventDefault(),t(a),i(!0)};window.addEventListener("beforeinstallprompt",d);const b=/iPad|iPhone|iPod/.test(navigator.userAgent),h=window.navigator.standalone;return b&&!h&&!localStorage.getItem("pwa-prompt-dismissed")&&setTimeout(()=>i(!0),5e3),()=>{window.removeEventListener("beforeinstallprompt",d)}},[]);const u=async()=>{if(s){s.prompt();const{outcome:d}=await s.userChoice;d==="accepted"&&console.log("PWA installed"),t(null),i(!1)}},g=()=>{i(!1),o(!0),localStorage.setItem("pwa-prompt-dismissed","true")},f=/iPad|iPhone|iPod/.test(navigator.userAgent);return!l||n?null:e.jsx("div",{className:"fixed bottom-4 left-4 right-4 z-50 md:left-auto md:right-4 md:max-w-sm",children:e.jsx("div",{className:"bg-gradient-to-r from-purple-600 to-pink-600 text-white rounded-2xl shadow-2xl p-4",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx("div",{className:"bg-white bg-opacity-20 rounded-full p-2",children:e.jsx(X,{className:"w-6 h-6"})}),e.jsxs("div",{className:"flex-1",children:[e.jsx("h3",{className:"font-bold text-lg mb-1",children:"アプリをインストール"}),e.jsx("p",{className:"text-sm opacity-90 mb-3",children:f?"このアプリをホーム画面に追加して、より便利にご利用ください。":"アプリをインストールして、オフラインでも使用できるようにしましょう。"}),f?e.jsx("div",{className:"text-xs opacity-80 mb-3",children:e.jsx("p",{children:"📱 Safari で「共有」→「ホーム画面に追加」をタップ"})}):null,e.jsxs("div",{className:"flex gap-2",children:[!f&&e.jsxs("button",{onClick:u,className:"flex-1 bg-white text-purple-600 font-bold py-2 px-4 rounded-lg flex items-center justify-center gap-2 hover:bg-gray-100 transition-colors",children:[e.jsx(Z,{className:"w-4 h-4"}),"インストール"]}),e.jsx("button",{onClick:g,className:"bg-white bg-opacity-20 hover:bg-opacity-30 text-white font-medium py-2 px-4 rounded-lg transition-colors",children:"後で"})]})]}),e.jsx("button",{onClick:g,className:"text-white text-opacity-70 hover:text-opacity-100 transition-colors",children:e.jsx(O,{className:"w-5 h-5"})})]})})})},we=()=>{const{user:s,loading:t}=y();return x.useEffect(()=>{oe(),s&&le()},[s]),t?e.jsx("div",{className:"min-h-screen flex items-center justify-center bg-gradient-to-br from-purple-400 via-pink-500 to-red-500",children:e.jsxs("div",{className:"text-center",children:[e.jsx("div",{className:"animate-spin rounded-full h-16 w-16 border-4 border-white border-t-transparent mx-auto mb-4"}),e.jsx("p",{className:"text-white text-lg font-medium",children:"読み込み中..."})]})}):e.jsxs(e.Fragment,{children:[s?e.jsx(ue,{children:e.jsx(ge,{})}):e.jsx(xe,{}),e.jsx(be,{})]})},je=()=>e.jsx(ne,{children:e.jsx(we,{})});I.createRoot(document.getElementById("root")).render(e.jsx(S.StrictMode,{children:e.jsx(U,{children:e.jsx(je,{})})}));export{e as j,p as s,y as u};
