import{u as E,j as e,s as f}from"./index-ba943a40.js";import{r as m}from"./vendor-ce4ffebd.js";import{b as S,i as M,u as I,U as k,l as A}from"./icons-828367c1.js";import"./routing-89dfa7f7.js";import"./supabase-e6e84841.js";const R=({onDataUpdate:h})=>{const{user:r}=E(),[t,x]=m.useState([]),[u,g]=m.useState(!0),[b,l]=m.useState(!1),[n,c]=m.useState("");m.useEffect(()=>{r&&v()},[r]);const p=async()=>{t.length===0&&await d()},d=async()=>{try{if(!r)return;const{data:a,error:s}=await f.from("users").select(`
          id,
          name,
          role,
          birth_date,
          age,
          created_at
        `).eq("family_id",r.familyId||"");if(s)throw s;const o=a.map(i=>({id:i.id,name:i.name,email:"",role:i.role,birthDate:i.birth_date?new Date(i.birth_date):void 0,age:i.age,createdAt:new Date(i.created_at)}));x(o)}catch(a){console.error("Error loading family members:",a)}finally{g(!1)}},v=()=>{const a=Math.random().toString(36).substring(2,8).toUpperCase();c(a)},D=async a=>{try{if(!(r!=null&&r.familyId))throw new Error("Family ID not found");const s=Math.random().toString(36).substring(2,8).toUpperCase(),o=r.email.split("@"),i=`${o[0]}+child${s}@${o[1]}`,j=`child${Math.random().toString(36).substring(2,6)}`;console.log("Creating child with email:",i);const{data:y,error:N}=await f.auth.signUp({email:i,password:j});if(N)throw N;if(y.user){const{error:w}=await f.from("users").insert({id:y.user.id,family_id:r.familyId,name:a.name,role:"CHILD",age:a.age,birth_date:a.birthDate||null,child_code:s});if(w)throw w;await d(),h&&h(),alert(`子供アカウントが作成されました！🎉

📱 子供用ログイン情報:
📧 メール: ${i}
🔑 パスワード: ${j}
👤 名前: ${a.name}

※メール確認が必要な場合があります`)}}catch(s){console.error("Error creating child account:",s),console.error("Error details:",JSON.stringify(s,null,2));let o="Unknown error";s instanceof Error?o=s.message:s&&typeof s=="object"&&(o=JSON.stringify(s,null,2)),alert(`子供アカウントの作成に失敗しました:

${o}

※ブラウザのConsoleタブで詳細を確認してください`)}},C=async a=>{if(confirm(`このメンバーを削除してもよろしいですか？
※データも全て削除されます`))try{const{error:s}=await f.from("users").delete().eq("id",a);if(s)throw s;await d(),alert("メンバーが削除されました")}catch(s){console.error("Error deleting member:",s),alert("メンバーの削除に失敗しました")}};return(r==null?void 0:r.role)!=="PARENT"?e.jsx("div",{className:"text-center py-8",children:e.jsx("p",{className:"text-gray-500",children:"家族管理は保護者のみアクセスできます"})}):u&&t.length===0?e.jsx("div",{className:"space-y-6",children:e.jsxs("div",{className:"text-center py-8",children:[e.jsx("h3",{className:"text-xl font-bold text-purple-700 mb-4",children:"👨‍👩‍👧‍👦 家族管理"}),e.jsx("button",{onClick:p,className:"btn-primary",children:"家族メンバーを読み込む"})]})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[e.jsx("h2",{className:"text-3xl font-bold text-purple-800",children:"👨‍👩‍👧‍👦 家族管理"}),e.jsxs("button",{onClick:()=>l(!0),className:"btn-primary flex items-center gap-2",children:[e.jsx(S,{className:"w-5 h-5"}),"子供を追加"]})]}),e.jsxs("div",{className:"card",children:[e.jsxs("h3",{className:"text-xl font-bold text-purple-700 mb-4 flex items-center gap-2",children:[e.jsx(M,{className:"w-6 h-6"}),"家族メンバー (",t.length,"人)"]}),e.jsx("div",{className:"grid gap-4",children:t.map(a=>e.jsx("div",{className:"p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-purple-200",children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"text-3xl",children:a.role==="PARENT"?e.jsx(I,{className:"w-8 h-8 text-yellow-500"}):e.jsx(k,{className:"w-8 h-8 text-blue-500"})}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-bold text-gray-800",children:a.name}),e.jsxs("div",{className:"flex gap-4 text-sm text-gray-600",children:[e.jsx("span",{className:`px-2 py-1 rounded-full text-xs font-medium ${a.role==="PARENT"?"bg-yellow-100 text-yellow-700":"bg-blue-100 text-blue-700"}`,children:a.role==="PARENT"?"保護者":"子供"}),a.age&&e.jsxs("span",{children:[a.age,"歳"]}),e.jsxs("span",{children:["参加日: ",a.createdAt.toLocaleDateString("ja-JP")]})]})]})]}),a.role==="CHILD"&&e.jsx("button",{onClick:()=>C(a.id),className:"p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-full transition-colors",title:"削除",children:e.jsx(A,{className:"w-4 h-4"})})]})},a.id))}),t.length===1&&e.jsxs("div",{className:"text-center py-8",children:[e.jsx("p",{className:"text-gray-500 mb-4",children:"まだ子供が参加していません"}),e.jsx("button",{onClick:()=>l(!0),className:"btn-secondary",children:"最初の子供を追加する"})]})]}),b&&e.jsx(F,{onClose:()=>l(!1),onSave:D})]})},F=({onClose:h,onSave:r})=>{const[t,x]=m.useState({name:"",age:"",birthDate:""}),u=l=>{if(!l)return"";const n=new Date,c=new Date(l);let p=n.getFullYear()-c.getFullYear();const d=n.getMonth()-c.getMonth();return(d<0||d===0&&n.getDate()<c.getDate())&&p--,p.toString()},g=l=>{const n=l.target.value,c=u(n);x({...t,birthDate:n,age:c})},b=l=>{if(l.preventDefault(),!t.name){alert("名前は必須です");return}let n;if(t.birthDate)n=parseInt(u(t.birthDate));else if(t.age)n=parseInt(t.age);else{alert("誕生日または年齢のどちらかを入力してください");return}if(n<1||n>18){alert("年齢は1歳から18歳までの範囲で入力してください");return}r({name:t.name,age:n,birthDate:t.birthDate?new Date(t.birthDate):void 0}),h()};return e.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:e.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-pink-50 rounded-3xl p-8 w-full max-w-md border-4 border-purple-300 shadow-2xl",children:[e.jsx("h3",{className:"text-2xl font-bold text-purple-800 mb-6 text-center",children:"👶 子供アカウントを作成"}),e.jsxs("form",{onSubmit:b,className:"space-y-4",children:[e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:"名前"}),e.jsx("input",{type:"text",value:t.name,onChange:l=>x({...t,name:l.target.value}),className:"input-field",placeholder:"例: 太郎",required:!0})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:"誕生日"}),e.jsx("input",{type:"date",value:t.birthDate,onChange:g,className:"input-field",max:new Date().toISOString().split("T")[0]}),e.jsx("p",{className:"text-xs text-purple-600 mt-1",children:"誕生日を入力すると年齢が自動計算されます"})]}),e.jsxs("div",{children:[e.jsxs("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:["年齢 ",t.birthDate&&"(自動計算)"]}),e.jsx("input",{type:"number",min:"1",max:"18",value:t.age,onChange:l=>x({...t,age:l.target.value}),className:"input-field",placeholder:"例: 8",disabled:!!t.birthDate}),e.jsx("p",{className:"text-xs text-purple-600 mt-1",children:t.birthDate?"誕生日から自動計算されています":"誕生日未入力の場合は手動で入力してください"})]}),e.jsxs("div",{className:"flex justify-center gap-4 pt-4",children:[e.jsx("button",{type:"button",onClick:h,className:"btn-secondary",children:"キャンセル"}),e.jsx("button",{type:"submit",className:"btn-primary",children:"作成"})]})]})]})})};export{R as default};
