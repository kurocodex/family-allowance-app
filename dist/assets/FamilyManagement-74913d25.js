import{u as e,j as t,s as a}from"./index-debdd620.js";import{r as s}from"./vendor-18e24f2a.js";import{b as r,l,x as n,U as i,o as c}from"./icons-61d3c260.js";import"./routing-3469486c.js";import"./supabase-c91fe37d.js";const o=({onDataUpdate:o})=>{const{user:m}=e(),[x,h]=s.useState([]),[p,u]=s.useState(!0),[b,f]=s.useState(!1);s.useEffect(()=>{m&&N()},[m]);const g=async()=>{0===x.length&&await j()},j=async()=>{try{if(!m)return;const{data:e,error:t}=await a.from("users").select("\n          id,\n          name,\n          role,\n          birth_date,\n          age,\n          created_at\n        ").eq("family_id",m.familyId||"");if(t)throw t;const s=e.map(e=>({id:e.id,name:e.name,email:"",role:e.role,birthDate:e.birth_date?new Date(e.birth_date):void 0,age:e.age,createdAt:new Date(e.created_at)}));h(s)}catch(e){}finally{u(!1)}},N=()=>{};return"PARENT"!==(null==m?void 0:m.role)?t.jsx("div",{className:"text-center py-8",children:t.jsx("p",{className:"text-gray-500",children:"家族管理は保護者のみアクセスできます"})}):p&&0===x.length?t.jsx("div",{className:"space-y-6",children:t.jsxs("div",{className:"text-center py-8",children:[t.jsx("h3",{className:"text-xl font-bold text-purple-700 mb-4",children:"👨‍👩‍👧‍👦 家族管理"}),t.jsx("button",{onClick:g,className:"btn-primary",children:"家族メンバーを読み込む"})]})}):t.jsxs("div",{className:"space-y-6",children:[t.jsxs("div",{className:"flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4",children:[t.jsx("h2",{className:"text-3xl font-bold text-purple-800",children:"👨‍👩‍👧‍👦 家族管理"}),t.jsxs("button",{onClick:()=>f(!0),className:"btn-primary flex items-center gap-2",children:[t.jsx(r,{className:"w-5 h-5"}),"子供を追加"]})]}),t.jsxs("div",{className:"card",children:[t.jsxs("h3",{className:"text-xl font-bold text-purple-700 mb-4 flex items-center gap-2",children:[t.jsx(l,{className:"w-6 h-6"}),"家族メンバー (",x.length,"人)"]}),t.jsx("div",{className:"grid gap-4",children:x.map(e=>t.jsx("div",{className:"p-4 bg-gradient-to-r from-blue-50 to-purple-50 rounded-lg border border-purple-200",children:t.jsxs("div",{className:"flex items-center justify-between",children:[t.jsxs("div",{className:"flex items-center gap-4",children:[t.jsx("div",{className:"text-3xl",children:"PARENT"===e.role?t.jsx(n,{className:"w-8 h-8 text-yellow-500"}):t.jsx(i,{className:"w-8 h-8 text-blue-500"})}),t.jsxs("div",{children:[t.jsx("h4",{className:"font-bold text-gray-800",children:e.name}),t.jsxs("div",{className:"flex gap-4 text-sm text-gray-600",children:[t.jsx("span",{className:"px-2 py-1 rounded-full text-xs font-medium "+("PARENT"===e.role?"bg-yellow-100 text-yellow-700":"bg-blue-100 text-blue-700"),children:"PARENT"===e.role?"保護者":"子供"}),e.age&&t.jsxs("span",{children:[e.age,"歳"]}),t.jsxs("span",{children:["参加日: ",e.createdAt.toLocaleDateString("ja-JP")]})]})]})]}),"CHILD"===e.role&&t.jsx("button",{onClick:()=>(async e=>{if(confirm("このメンバーを削除してもよろしいですか？\n※データも全て削除されます"))try{const{error:t}=await a.from("users").delete().eq("id",e);if(t)throw t;await j(),alert("メンバーが削除されました")}catch(t){alert("メンバーの削除に失敗しました")}})(e.id),className:"p-2 text-red-500 hover:text-red-700 hover:bg-red-50 rounded-full transition-colors",title:"削除",children:t.jsx(c,{className:"w-4 h-4"})})]})},e.id))}),1===x.length&&t.jsxs("div",{className:"text-center py-8",children:[t.jsx("p",{className:"text-gray-500 mb-4",children:"まだ子供が参加していません"}),t.jsx("button",{onClick:()=>f(!0),className:"btn-secondary",children:"最初の子供を追加する"})]})]}),b&&t.jsx(d,{onClose:()=>f(!1),onSave:async e=>{try{if(!(null==m?void 0:m.familyId))throw new Error("Family ID not found");const t=Math.random().toString(36).substring(2,8).toUpperCase(),s=m.email.split("@"),r=`${s[0]}+child${t}@${s[1]}`,l=`child${Math.random().toString(36).substring(2,6)}`,{data:n,error:i}=await a.auth.signUp({email:r,password:l});if(i)throw i;if(n.user){const{error:s}=await a.from("users").insert({id:n.user.id,family_id:m.familyId,name:e.name,role:"CHILD",age:e.age,birth_date:e.birthDate||null,child_code:t});if(s)throw s;await j(),o&&o(),alert(`子供アカウントが作成されました！🎉\n\n📱 子供用ログイン情報:\n📧 メール: ${r}\n🔑 パスワード: ${l}\n👤 名前: ${e.name}\n\n※メール確認が必要な場合があります`)}}catch(t){let e="Unknown error";t instanceof Error?e=t.message:t&&"object"==typeof t&&(e=JSON.stringify(t,null,2)),alert(`子供アカウントの作成に失敗しました:\n\n${e}\n\n※ブラウザのConsoleタブで詳細を確認してください`)}}})]})},d=({onClose:e,onSave:a})=>{const[r,l]=s.useState({name:"",age:"",birthDate:""}),n=e=>{if(!e)return"";const t=new Date,a=new Date(e);let s=t.getFullYear()-a.getFullYear();const r=t.getMonth()-a.getMonth();return(r<0||0===r&&t.getDate()<a.getDate())&&s--,s.toString()};return t.jsx("div",{className:"fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50",children:t.jsxs("div",{className:"bg-gradient-to-br from-purple-50 to-pink-50 rounded-3xl p-8 w-full max-w-md border-4 border-purple-300 shadow-2xl",children:[t.jsx("h3",{className:"text-2xl font-bold text-purple-800 mb-6 text-center",children:"👶 子供アカウントを作成"}),t.jsxs("form",{onSubmit:t=>{if(t.preventDefault(),!r.name)return void alert("名前は必須です");let s;if(r.birthDate)s=parseInt(n(r.birthDate));else{if(!r.age)return void alert("誕生日または年齢のどちらかを入力してください");s=parseInt(r.age)}s<1||s>18?alert("年齢は1歳から18歳までの範囲で入力してください"):(a({name:r.name,age:s,birthDate:r.birthDate?new Date(r.birthDate):void 0}),e())},className:"space-y-4",children:[t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:"名前"}),t.jsx("input",{type:"text",value:r.name,onChange:e=>l({...r,name:e.target.value}),className:"input-field",placeholder:"例: 太郎",required:!0})]}),t.jsxs("div",{children:[t.jsx("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:"誕生日"}),t.jsx("input",{type:"date",value:r.birthDate,onChange:e=>{const t=e.target.value,a=n(t);l({...r,birthDate:t,age:a})},className:"input-field",max:(new Date).toISOString().split("T")[0]}),t.jsx("p",{className:"text-xs text-purple-600 mt-1",children:"誕生日を入力すると年齢が自動計算されます"})]}),t.jsxs("div",{children:[t.jsxs("label",{className:"block text-sm font-medium text-purple-700 mb-2",children:["年齢 ",r.birthDate&&"(自動計算)"]}),t.jsx("input",{type:"number",min:"1",max:"18",value:r.age,onChange:e=>l({...r,age:e.target.value}),className:"input-field",placeholder:"例: 8",disabled:!!r.birthDate}),t.jsx("p",{className:"text-xs text-purple-600 mt-1",children:r.birthDate?"誕生日から自動計算されています":"誕生日未入力の場合は手動で入力してください"})]}),t.jsxs("div",{className:"flex justify-center gap-4 pt-4",children:[t.jsx("button",{type:"button",onClick:e,className:"btn-secondary",children:"キャンセル"}),t.jsx("button",{type:"submit",className:"btn-primary",children:"作成"})]})]})]})})};export{o as default};
